@page "/beorg/dossier"

@using MudBlazor
@using PortailMetier.Domain.Dtos
@using PortailMetier.Domain.Interfaces

@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject IGedService GedService

<MudPaper Class="d-flex flex-column" Style="height: 100%; width: 100%;" Elevation="0">

    <!-- Barre d'outils -->
    <MudToolBar Dense="true">
        <MudMenu Label="Récents" Variant="Variant.Text" EndIcon="@Icons.Material.Filled.ArrowDropDown">
            <MudMenuItem>25.01.116 MG GR POLE SANTE</MudMenuItem>
            <MudMenuItem>24.10.170 YB PE MANITOU</MudMenuItem>
        </MudMenu>

        <MudButton Variant="Variant.Text" OnClick="@OpenSearchDialog">
            Rechercher
        </MudButton>

        <MudSpacer />

        <MudText Typo="Typo.body2" Class="mr-2">Dossier :</MudText>
        <MudText Typo="Typo.body1"><b>@(_dossierCourant?.Nom ?? "Aucun")</b></MudText>
    </MudToolBar>

    <!-- Corps -->
    <MudGrid Spacing="0" Class="flex-grow-1" Style="height: 0; overflow: hidden;">

        <!-- Arborescence -->
        <MudItem xs="12" sm="4" md="3" Class="pa-2"
            Style="border-right: 1px solid #ddd; height: 100%; overflow-y: auto;">
            <MudText Typo="Typo.h6" Class="mb-2">Arborescence</MudText>

            @if (_isLoadingArborescence)
            {
                <MudProgressCircular Indeterminate="true" />
            }
            else
            {
                <MudTreeView T="DossierDto" Items="@_treeItems" CanSelect="true" SelectedValue="@_dossierCourant"
                    SelectedValueChanged="@OnTreeSelectionChanged">

                    <ItemTemplate>
                        @{
                            // context est TreeItemData<DossierDto> en v7
                            var node = (TreeItemData<DossierDto>)context;
                            var dossier = node.Value;
                        }

                        <MudTreeViewItem T="DossierDto" Value="@dossier" Text="@(dossier?.Nom ?? "")"
                            Icon="@Icons.Material.Filled.Folder" Items="@node.Children" />
                    </ItemTemplate>
                </MudTreeView>
            }
        </MudItem>

        <!-- Fichiers -->
        <MudItem xs="12" sm="8" md="9" Class="pa-2" Style="height: 100%; overflow-y: auto;">
            <MudText Typo="Typo.h6" Class="mb-2">Fichiers</MudText>

            <MudTable T="FichierDto" Items="@_fichiers" Hover="true" Dense="true" FixedHeader="true"
                Height="calc(100% - 50px)" Loading="@_isLoadingFichiers">

                <HeaderContent>
                    <MudTh>Nom</MudTh>
                    <MudTh>Taille</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Modifié le</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="Nom">
                        <MudIcon Icon="@GetFileIcon(context.Type)" Size="Size.Small" Class="mr-2" />
                        @context.Nom
                    </MudTd>
                    <MudTd DataLabel="Taille">@context.TailleHumaine</MudTd>
                    <MudTd DataLabel="Type">@context.Type</MudTd>
                    <MudTd DataLabel="Modifié le">@context.DateModifUtc.ToLocalTime().ToString("g")</MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Color="Color.Primary"
                            Tooltip="Ouvrir" OnClick="@(() => OpenFile(context))" />
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudText>Aucun fichier dans ce dossier.</MudText>
                </NoRecordsContent>
            </MudTable>
        </MudItem>
    </MudGrid>

    <!-- Bandeau chemin -->
    <MudPaper Elevation="2" Class="pa-2" Square="true">
        <MudText Typo="Typo.caption">
            <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1" />
            @(_dossierCourant?.CheminCompletUNC ?? "")
        </MudText>
    </MudPaper>
</MudPaper>

@code {
    private IReadOnlyCollection<TreeItemData<DossierDto>> _treeItems = Array.Empty<TreeItemData<DossierDto>>();
    private DossierDto? _dossierCourant;
    private List<FichierDto> _fichiers = new();

    private bool _isLoadingArborescence = true;
    private bool _isLoadingFichiers = false;

    protected override async Task OnInitializedAsync()
    {
        // Récupère l'arbo DossierDto avec SousDossiers déjà remplis
        var racines = await GedService.GetArborescenceDossiersAsync();
        _treeItems = BuildTreeItems(racines);
        _isLoadingArborescence = false;

        if (racines.Any())
        {
            await SelectDossier(racines.First());
        }
    }

    // Construction TreeItemData v7 : Value = DossierDto, Children = enfants
    // Construction TreeItemData v7 : Value = DossierDto, Children = enfants
    private IReadOnlyCollection<TreeItemData<DossierDto>> BuildTreeItems(List<DossierDto> racines)
    {
        var list = new List<TreeItemData<DossierDto>>();

        foreach (var dossier in racines)
        {
            var node = new TreeItemData<DossierDto>
            {
                Value = dossier,
                Children = BuildChildrenAsList(dossier.SousDossiers) // ✅ Nouvelle méthode
            };
            list.Add(node);
        }

        return list.AsReadOnly();
    }

    private List<TreeItemData<DossierDto>> BuildChildrenAsList(List<DossierDto> enfants)
    {
        var list = new List<TreeItemData<DossierDto>>();

        foreach (var d in enfants)
        {
            var child = new TreeItemData<DossierDto>
            {
                Value = d,
                Children = BuildChildrenAsList(d.SousDossiers) // ✅ Récursif
            };
            list.Add(child);
        }

        return list; // ✅ Retourne List directement
    }

    private async Task OnTreeSelectionChanged(DossierDto? dossier)
    {
        if (dossier is null || dossier == _dossierCourant)
            return;

        await SelectDossier(dossier);
    }

    private async Task SelectDossier(DossierDto dossier)
    {
        _dossierCourant = dossier;
        _isLoadingFichiers = true;
        _fichiers.Clear();
        StateHasChanged();

        _fichiers = await GedService.GetFichiersAsync(dossier.CheminCompletUNC ?? string.Empty);
        _isLoadingFichiers = false;
        StateHasChanged();
    }

    private async Task OpenFile(FichierDto file)
    {
        if (string.IsNullOrWhiteSpace(file.CheminCompletUNC))
            return;

        var path = file.CheminCompletUNC.Replace('\\', '/');
        await JSRuntime.InvokeVoidAsync("window.open", $"file:///{path}");
    }

    private string GetFileIcon(string fileType)
    {
        return fileType switch
        {
            "Fichier PDF" => Icons.Material.Filled.PictureAsPdf,
            "Fichier Revit" => Icons.Material.Filled.Architecture,
            "Document Word" => Icons.Material.Filled.Description,
            "Feuille de calcul Excel" => Icons.Material.Filled.TableChart,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private async Task OpenSearchDialog()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<Frontend.Components.Dialogs.SearchDialog>("Rechercher un dossier", options);

        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is DossierDto selectedDossier) // ✅ CORRECTION
        {
            await SelectDossier(selectedDossier);
        }
    }
}