@using IDES.Portail.MAUI.Services
@inject GraphService GraphService
@inject NavigationManager NavigationManager

<div class="auth-container pa-4">
    @if (!GraphService.IsAuthenticated)
    {
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.Login"
                   OnClick="OnLoginClicked"
                   Disabled="_isProcessing">
            @( _isProcessing ? "Connexion en cours..." : "Connexion Microsoft 365" )
        </MudButton>
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-2">@_errorMessage</MudAlert>
        }
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <MudAvatar Color="Color.Secondary">@GraphService.UserName?[0].ToString().ToUpper()</MudAvatar>
            <MudText>Connecté en tant que <b>@GraphService.UserName</b></MudText>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Error" 
                       Size="Size.Small"
                       OnClick="OnLogoutClicked">
                Déconnexion
            </MudButton>
        </MudStack>
    }
</div>

@code {
    private bool _isProcessing = false;
    private string? _errorMessage;

    private async Task OnLoginClicked()
    {
        try
        {
            _isProcessing = true;
            _errorMessage = null;
            
            var result = await GraphService.LoginAsync();
            
            if (result != null)
            {
                // Rediriger vers le calendrier après succès
                NavigationManager.NavigateTo("/calendar");
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Erreur d'authentification : {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task OnLogoutClicked()
    {
        await GraphService.LogoutAsync();
        NavigationManager.NavigateTo("/");
    }
}
