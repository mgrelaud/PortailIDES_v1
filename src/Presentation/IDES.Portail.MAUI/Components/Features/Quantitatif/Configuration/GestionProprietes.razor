@page "/quantitatif/configuration/proprietes"
@layout QuantitatifLayout
@using Microsoft.AspNetCore.Components.Sections
@inject ICatalogueService CatalogueService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<SectionContent SectionName="FeatureTitle">
    Quantitatif Béton - Propriétés
</SectionContent>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Gestion des Propriétés</MudText>
    
    <MudTable Items="@_proprietes" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" 
              Filter="new Func<DefinitionPropriete,bool>(FilterFunc1)" @bind-SelectedItem="_selectedItem1">
        <ToolBarContent>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AjouterPropriete" StartIcon="@Icons.Material.Filled.Add">Nouvelle Propriété</MudButton>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString1" Placeholder="Rechercher" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Nom</MudTh>
            <MudTh>Affichage</MudTh>
            <MudTh>Type</MudTh>
            <MudTh>Unité</MudTh>
            <MudTh>Catégorie</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Nom">@context.Nom</MudTd>
            <MudTd DataLabel="Affichage">@context.NomAffichage</MudTd>
            <MudTd DataLabel="Type">@context.TypeDonnee</MudTd>
            <MudTd DataLabel="Unité">@context.Unite</MudTd>
            <MudTd DataLabel="Catégorie">@context.Categorie</MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" OnClick="@(() => EditerPropriete(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => SupprimerPropriete(context))" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudContainer>

<MudDialog @bind-Visible="_isDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(_editPropriete.Id == 0 ? "Nouvelle Propriété" : "Modifier Propriété")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_success">
            <MudTextField T="string" Label="Nom (interne)" Required="true" @bind-Value="_editPropriete.Nom" />
            <MudTextField T="string" Label="Nom Affichage" Required="true" @bind-Value="_editPropriete.NomAffichage" />
            <MudSelect T="string" Label="Type de donnée" Required="true" @bind-Value="_editPropriete.TypeDonnee">
                <MudSelectItem Value="@("Double")">Double</MudSelectItem>
                <MudSelectItem Value="@("String")">String</MudSelectItem>
                <MudSelectItem Value="@("Bool")">Bool</MudSelectItem>
                <MudSelectItem Value="@("Formule")">Formule</MudSelectItem>
            </MudSelect>
            <MudTextField T="string" Label="Unité" @bind-Value="_editPropriete.Unite" />
            <MudTextField T="string" Label="Catégorie" @bind-Value="_editPropriete.Categorie" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="Cancel" Class="px-10">Annuler</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save" Class="px-10">Enregistrer</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<DefinitionPropriete> _proprietes = new();
    private bool _loading = true;
    private string _searchString1 = "";
    private DefinitionPropriete _selectedItem1 = null!;
    private DefinitionPropriete _editPropriete = new();
    private bool _isDialogVisible;
    private bool _success;
    private MudForm _form = null!;
    private DialogOptions _dialogOptions = new() { FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _proprietes = await CatalogueService.GetToutesLesProprietesAsync();
        _loading = false;
    }

    private bool FilterFunc1(DefinitionPropriete element) => FilterFunc(element, _searchString1);

    private bool FilterFunc(DefinitionPropriete element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.Nom.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.NomAffichage.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.Categorie?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
            return true;
        return false;
    }

    private void AjouterPropriete()
    {
        _editPropriete = new DefinitionPropriete();
        _isDialogVisible = true;
    }

    private void EditerPropriete(DefinitionPropriete propriete)
    {
        _editPropriete = new DefinitionPropriete
        {
            Id = propriete.Id,
            Nom = propriete.Nom,
            NomAffichage = propriete.NomAffichage,
            TypeDonnee = propriete.TypeDonnee,
            Unite = propriete.Unite,
            Categorie = propriete.Categorie
        };
        _isDialogVisible = true;
    }

    private async Task SupprimerPropriete(DefinitionPropriete propriete)
    {
        bool isUsed = await CatalogueService.EstProprieteUtiliseeAsync(propriete.Id);
        if (isUsed)
        {
            Snackbar.Add("Impossible de supprimer cette propriété car elle est utilisée dans le catalogue.", Severity.Error);
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            "Confirmation", 
            $"Voulez-vous vraiment supprimer la propriété '{propriete.NomAffichage}' ?", 
            yesText: "Supprimer", cancelText: "Annuler");

        if (result == true)
        {
            await CatalogueService.DeleteProprieteAsync(propriete.Id);
            Snackbar.Add("Propriété supprimée", Severity.Success);
            await LoadData();
        }
    }

    private void Cancel() => _isDialogVisible = false;

    private async Task Save()
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            await CatalogueService.SaveProprieteAsync(_editPropriete);
            Snackbar.Add("Propriété enregistrée", Severity.Success);
            _isDialogVisible = false;
            await LoadData();
        }
    }
}
